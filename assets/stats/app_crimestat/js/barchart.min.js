/**
 * Dynamic bar chart
 *
 * Author: CSC (HVE, KCA)
 * Date: 28 Nov 2012
 * 
 * Modification
 *   - TMA 201311: customisations for the fedpol
 *       - increase width (800->860) and height (350->400) and legend_width (113->313)
 *       - inverse legend order to have the same color order as the bars
 *       - translate in EN and DE
 *       - align the x labels with the bars
 *       - modify the fallback part
*/ 
 
var l_width=860,l_height=400,l_legend_width=213,l_html_page=window.location.href.split(".")[0].split("/"),l_html_page=l_html_page[l_html_page.length-1],Barchart=function(){return function(){function l(c){null==c&&(c=!1);var b=a.viz.scope.selectAll(".layer rect").filter(function(b){return 0<=a.legend.active.indexOf(b.d)}).transition().duration(500);c||(b=b.delay(function(b,c){return c%a.m*10}));b.attr("x",function(b,c){return a.x({x:0.9*Math.floor(c/a.m)/a.n})}).attr("width",a.x({x:0.9/a.n})).each("end",
function(){d3.select(this).transition().duration(500).delay(25).attr("y",function(b){return a.height-a.y2(b)}).attr("height",a.y2)});a.mode="grouped";a.redrawAxes()}function m(){a.viz.scope.selectAll(".layer rect").filter(function(c){return 0<=a.legend.active.indexOf(c.d)}).transition().duration(500).delay(function(c,b){return b%a.m*10}).attr("y",a.y1).attr("height",function(c){return a.y0(c)-a.y1(c)}).each("end",function(){d3.select(this).transition().duration(500).delay(25).attr("x",0).attr("width",
a.x({x:0.9}))});a.viz.scope.selectAll(".layer rect").filter(function(c){return 0>a.legend.active.indexOf(c.d)}).attr("y",a.y0).attr("x",0).attr("width",a.x({x:0.9}));a.mode="stacked";a.redrawAxes()}var a=this;a.name="barchart";a.keys=[];a.data=[];a.originalMatrix=[];a.width;a.height;a.margins={left:60,right:10,top:30,bottom:20};a.legendWidth=l_legend_width;a.tooltip;a.m;a.n;a.mx;a.my;a.mz;a.x;a.y0;a.y1;a.y2;a.rect=[];a.mode="stacked";a.stack;a.matrix=[];a.bind=function(a){d3.select(a).append("div").classed("body barchart",
!0).html('  <div class="tooltip hidden"></div>    <div class="legend">      <div class="options">      <span class="sidebar-title options-title">Groepering</span>      <label><input type="checkbox" name="mode" value="grouped" checked><span class="changeGrouping-title">Gestapeld</span></label>    </div>    <div class="series">      <span class="sidebar-title legend-title">Legende</span>    </div>  </div>')};a.updateData=function(c){var b=a.viz.definition.evolution.dimension,d=a.viz.data.dimensions[b];
a.legend.active.forEach(function(b,d){a.matrix[d]=[]});d3.entries(c).forEach(function(c,g){a.legend.active.forEach(function(k,h){var n=f.informat(c.value[k],a.viz.data.measures[k].type,a.viz.data.measures[k].informat,a.viz.lang);a.matrix[h][g]={x:g,xd:f.informat(c.value[b],d.type,d.informat),y:n,d:k}})});a.stack=d3.layout.stack();a.data=a.stack(a.matrix);jQuery.extend(a.originalMatrix,a.matrix)};this.determineMaxLength=function(){this.maxLength=0;d3.entries(a.viz.original.facts).forEach(function(c,
b){a.keys.forEach(function(b,e){var g=f.format(c.value[b],a.viz.data.measures[b],a.viz.definition.bars[e].format[a.viz.lang]);a.maxLength=g.length>a.maxLength?g.length:a.maxLength})})};a.initialize=function(){a.viz.changeDimensions((a.viz.getUrlVar("width")||l_width)*a.viz.size,(a.viz.getUrlVar("height")||l_height)*a.viz.size,!1);a.keys=a.viz.definition.bars.map(function(a){return a.measure});a.legend.initialize();a.determineMaxLength();a.updateData(a.viz.data.facts);1==a.keys.length&&(a.legendWidth=
0);a.m=a.matrix[0].length;a.mx=a.m;a.x=function(b){return b.x*a.width/a.mx};a.margins.left=15+6*a.maxLength;a.width=a.viz.width-a.legendWidth-a.margins.left-a.margins.right;a.height=a.viz.height-a.margins.top-a.margins.bottom;var c=a.viz.scope.select(".chart").attr("width",a.viz.width-a.legendWidth).attr("height",a.height+a.margins.top+a.margins.bottom);c.append("g").attr("class","axis-x").attr("transform","translate(0,"+(a.height+a.margins.top-3)+")");c.append("g").attr("class","axis-y").attr("transform",
"translate("+a.margins.left+",0)");var b=c.selectAll(".layer").data(a.data).enter().append("g").attr("class",function(b,c){return"layer layer-"+a.keys[c]}).style("fill",function(b,c){return a.viz.definition.bars[c].color}).selectAll(".bar").data(function(a){return a}).enter().append("g").attr("class","bar").attr("transform",function(b){return"translate("+(a.x(b)+a.margins.left)+","+a.margins.top+")"}).on("mouseover",a.showTooltip).on("mousemove",a.moveTooltip).on("mouseout",a.hideTooltip);a.rect=
b.append("rect");c.append("svg:text").attr("class","title").attr("transform","translate("+(a.width+a.margins.left+a.margins.right)/2+",20)").attr("text-anchor","middle").text(a.viz.definition.subject[a.viz.lang].title);("render"==a.viz.mode||1>=a.viz.definition.visualisations.possible.length)&&a.viz.scope.select(".options").hide();a.viz.scope.select(".changeGrouping-title").text(a.locale.text.Stacked);a.viz.scope.select(".options-title").text(a.locale.text.Grouping);a.viz.scope.selectAll(".options input").on("change",
function(){this.checked?m():l()});a.tooltip=a.viz.scope.select(".tooltip");a.redraw(!1,!0);"grouped"==a.viz.definition.visualisations["default"]&&(l(!0),a.viz.scope.select(".options input").property("checked",""))};a.redrawAxes=function(){var c,b=a.viz.data.dimensions[a.viz.definition.evolution.dimension],d=a.x({x:0.9});"date"==b.type?c=d3.time.scale().domain(d3.extent(a.data[0],function(a){return a.xd})).range([a.margins.left+d/2,a.viz.width-a.legendWidth-a.margins.right-d/2]):"hierarchy"==b.type&&
(c=d3.scale.ordinal().domain(Hierarchy.values(b.values)).rangePoints([a.margins.left,a.viz.width-a.legendWidth-a.margins.right],1));c=d3.svg.axis().scale(c).tickFormat(function(c){return f.format(c,b,a.viz.definition.evolution.format[a.viz.lang],a.viz.lang)});d=d3.scale.linear().range([a.height+a.margins.top,a.margins.top]);"grouped"==a.mode?d.domain([0,a.mz]):d.domain([0,a.my]);d=d3.svg.axis().orient("left").scale(d).tickFormat(d3.format(a.viz.definition.bars[0].format[a.viz.lang]));a.viz.scope.select(".axis-x").transition().duration(500).call(c);
a.viz.scope.select(".axis-y").transition().duration(500).call(d)};a.redraw=function(c,b){var d=a.legend.active.length-a.matrix.length;a.matrix=[];a.legend.active.forEach(function(b,c){a.matrix[c]=a.originalMatrix[a.keys.indexOf(b)]});a.data=a.stack(a.matrix);a.n=a.data.length;a.my=d3.max(a.data,function(a){return d3.max(a,function(a){return a.y0+a.y})});a.mz=d3.max(a.data,function(a){return d3.max(a,function(a){return a.y})});a.y0=function(b){return a.height-b.y0*a.height/a.my};a.y1=function(b){return a.height-
(b.y+b.y0)*a.height/a.my};a.y2=function(b){return b.y*a.height/a.mz};a.redrawAxes();if(b){var e=a.rect.attr("width",a.x({x:0.9})).attr("x",0).attr("y",a.height).attr("height",0);"render"!=a.viz.mode&&(e=e.transition().delay(function(b,c){return 40*Math.floor(c/(a.m/12))-c}));e.attr("y",a.y1).attr("height",function(b){return a.y0(b)-a.y1(b)})}else{var g=0;a.keys.forEach(function(b,c){var e=a.viz.scope.select(".layer-"+b);0>a.legend.active.indexOf(b)?e.selectAll("rect").transition().duration(500).delay(function(a,
b){return 10*b}).attr("y","stacked"==a.mode?a.y0:a.height).attr("height",0):"stacked"==a.mode?e.selectAll("rect").transition().duration(500).delay(function(a,b){return 10*b}).attr("height",function(b){return a.y0(b)-a.y1(b)}).attr("y",a.y1):(0<d?e.selectAll("rect").transition().duration(500).delay(function(a,b){return 10*b}).attr("x",function(b){return a.x({x:0.9*a.legend.active.indexOf(b.d)/a.n})}).attr("width",a.x({x:0.9/a.n})).each("end",function(b){d3.select(this).transition().duration(500).delay(25).attr("y",
function(b){return a.height-a.y2(b)}).attr("height",a.y2)}):0>d?e.selectAll("rect").transition().duration(500).delay(function(a,b){return 10*b}).attr("y",function(b){return a.height-a.y2(b)}).attr("height",a.y2).each("end",function(b){d3.select(this).transition().duration(500).delay(25).attr("x",function(b){return a.x({x:0.9*a.legend.active.indexOf(b.d)/a.n})}).attr("width",a.x({x:0.9/a.n}))}):(a.m=a.matrix[0].length,a.mx=a.m,a.x=function(b){return b.x*a.width/a.mx},e=e.selectAll(".bar").data(a.data[g]),
e.transition().duration(500).attr("transform",function(b){return"translate("+(a.x(b)+a.margins.left)+","+a.margins.top+")"}),e.select("rect").transition().duration(500).attr("y",function(b){return a.height-a.y2(b)}).attr("height",a.y2).attr("x",function(b){return a.x({x:0.9*a.legend.active.indexOf(b.d)/a.n})}).attr("width",a.x({x:0.9/a.n})),e.enter().append("g").attr("class","bar").attr("transform",function(b){return"translate("+(a.x(b)+a.margins.left)+","+a.margins.top+")"}).on("mouseover",a.showTooltip).on("mousemove",
a.moveTooltip).on("mouseout",a.hideTooltip).append("rect").attr("y",a.height).attr("x",function(b){return a.x({x:0.9*a.legend.active.indexOf(b.d)/a.n})}).attr("width",a.x({x:0.9/a.n})).transition().delay(500).duration(500).attr("y",function(b){return a.height-a.y2(b)}).attr("height",a.y2),e.exit().transition().duration(500).style("opacity",0).remove()),g++)})}};a.showTooltip=function(){a.tooltip.show().transition().duration(50).style("opacity",1E-5);d3.select(this).style("stroke","black");var c=d3.select(d3.event.target).datum();
a.tooltip.text("");a.tooltip.append("span").attr("class","tooltipkey").text(f.format(c.xd,a.viz.data.dimensions[a.viz.definition.evolution.dimension],a.viz.definition.evolution.format[a.viz.lang],a.viz.lang));a.tooltip.append("table");for(var b=a.keys.filter(a.legend.isActive),d=[],e=0,g=0;g<b.length;g++)d[g]=a.data[g].filter(function(a){return a.x==c.x})[0].y,e+=d[g];for(g=0;g<b.length;g++){var k=a.keys.indexOf(b[g]),h=a.tooltip.select("table").append("tr");h.append("th").text(a.viz.definition.bars[k].label[a.viz.lang]);
h.append("td").text(f.format(d[g],a.viz.data.measures[b[g]],a.viz.definition.bars[k].format[a.viz.lang],a.viz.lang));1<b.length&&(void 0===a.viz.definition.options||!1===a.viz.definition.options.totals)&&h.append("td").text(f.format(d[g]/e,{type:"numeric"},".2%",a.viz.lang))}1<b.length&&(void 0===a.viz.definition.options||!1===a.viz.definition.options.totals)&&(h=a.tooltip.select("table").append("tr"),h.append("th").text(a.locale.text.Total),k=a.keys.indexOf(b[0]),h.append("td").text(f.format(e,a.viz.data.measures[b[0]],
a.viz.definition.bars[k].format[a.viz.lang])),h.append("td"));a.tooltip.transition().duration(50).style("opacity",1)};a.moveTooltip=function(){var c=d3.event.pageX-$(a.viz.scopeStr+" .body").offset().left,b=d3.event.pageY-$(a.viz.scopeStr+" .body").offset().top,d=a.tooltip.height(),e=a.tooltip.width(),c=c>a.width-e-15?c-e-30:c+15,b=b<d+30?15:b-d-15;a.tooltip.style("left",c+"px").style("top",b+"px")};a.hideTooltip=function(){d3.select(this).style("stroke","none");a.tooltip.transition().duration(250).style("opacity",
1E-5).each("end",function(){a.tooltip.hide()})};a.fallback=function(){a.viz.changeDimensions((a.viz.getUrlVar("width")||l_width)*a.viz.size,(a.viz.getUrlVar("height")||l_height+45)*a.viz.size,!1);$(".legend").hide();$(".barchart").append("<div align='center'>  <img id='fallback'>");size=1>a.viz.size?0.7>a.viz.size?0.9*a.viz.size:0.95*a.viz.size:a.viz.size;date=new Date;dateStr=""+date.getFullYear()+(date.getMonth()+1)+date.getDate();$("#fallback").attr("src","css/images/fallback/"+l_html_page+"_"+
a.viz.lang+".png?d="+dateStr)};a.reset=function(){a.legend.reset()};a.locale=function(){var a={lang:"NL",text:{}},b={NL:{},FR:{},EN:{},DE:{}};a.select=function(d){a.text=b[d]};b.FR.Months="janvier f\u00e9vrier mars avril mai juin juillet ao\u00fbt septembre octobre novembre d\u00e9cembre".split(" ");b.FR.Days="dimanche lundi mardi mercredi jeudi vendredi samedi".split(" ");b.FR.Options="Param\u00e8tres";b.FR.NoSVG="Votre browser ne supporte pas des visualisations en SVG. Faites un update ou utilisez un browser avec SVG-support pour pouvoir voir cette visualisation.";
b.FR.Export="Faites l'export des donn\u00e9es (format .CSV)";b.FR.ExportHelp="* Copiez-collez par example en Excel";b.FR.Stacked="Empil\u00e9";b.FR.Legend="L\u00e9gende";b.FR.Total="TOTAL";b.FR.Grouping="Groupement";b.FR.Metadata="Telecharger la fiche de metadonn\u00e9es";b.NL.Months="januari februari maart april mei juni juli augustus september oktober november december".split(" ");b.NL.Days="zondag maandag dinsdag woensdag donderdag vrijdag zaterdag".split(" ");b.NL.Options="Opties";b.NL.NoSVG=
"Uw browser ondersteunt deze visualisatie die gebruikt maakt van de SVG-technologie niet goed. U dient uw browser te updaten om deze visualisatie in optimale omstandigheden te kunnen gebruiken.";b.NL.Export="Exporteer gegevens (.CSV-formaat)";b.NL.ExportHelp="* Kopieer bv. in Excel";b.NL.Stacked="Gestapeld";b.NL.Legend="Legende";b.NL.Total="Totaal";b.NL.Grouping="Groepering";b.NL.Metadata="Download metadata-fiche";b.EN.Months="january february march april may june july august september october november december".split(" ");
b.EN.Days="sunday monday tuesday wednesday thursday friday saturday".split(" ");b.EN.Options="Options";b.EN.NoSVG="Your browser does not support SVG visualisations. Use another browser with SVG support to see this visualisation.";b.EN.Export="Export data (.CSV-format)";b.EN.ExportHelp="* Copy ex. in Excel";b.EN.Stacked="Stacked";b.EN.Legend="Legend";b.EN.Total="Total";b.EN.Grouping="Grouped";b.EN.Metadata="Download metadata-file";b.DE.Months="januar februar m\u00e4rz april mai juni juli august september oktober november dezember".split(" ");
b.DE.Days="sonntag montag dienstag mittwoch donnerstag freitag samstag".split(" ");b.DE.Options="Optionen";b.DE.NoSVG="Ihrem Browser kann diese Visualisierung, die der SVG-Technologie nutzt nicht richtig visualisieren. Um optimale bedingungen zu bekommen, m\u00fcssen Sie ihrem Browser aktualisieren.";b.DE.Export="Data umsetzen (.CSV-formaat)";b.DE.ExportHelp="* Kopieren Sie diesem Beispiel in Excel";b.DE.Stacked="gestapelt";b.DE.Legend="Legende";b.DE.Total="Total";b.DE.Grouping="Gruppe";b.DE.Metadata=
"Metadaten-Datei herunterladen";return a}();a.legend=function(){function c(){a.viz.scope.select(".legend").style("display","block");if(1<a.keys.length)for(a.viz.scope.select(".legend-title").text(a.locale.text.Legend),i=a.keys.length-1;0<=i;i--){var c=a.viz.scope.select(".legend .series").append("div").attr("class","legend-series").attr("id",a.keys[i]).on("click",b.toggle);c.append("div").attr("class","legend-box").style("background-color",a.viz.definition.bars[i].color);c.append("div").attr("class",
"legend-label").text(a.viz.definition.bars[i].label[a.viz.lang]);c.on("mouseover",function(b){for(var c=d3.select(this)[0][0].id,d=d3.select(this)[0][0],h=b=0;!d3.select(d).classed("body");)b+=d.offsetLeft,h+=d.offsetTop,d=d.offsetParent;a.tooltip.text(a.viz.definition.bars[a.keys.indexOf(c)].label[a.viz.lang]).show();c=a.tooltip.width();a.tooltip.style("left",b-c-25+"px").style("top",h-5+"px").transition().duration(150).style("opacity",1)}).on("mouseout",a.hideTooltip)}else a.viz.scope.select(".legend").hide()}
var b={};b.active;b.initialize=function(){b.active=a.keys.slice(0);c()};b.toggle=function(){var c=d3.select(this);if(-1!=b.active.indexOf(c.attr("id")))1<b.active.length&&(c.transition().style("opacity","0.3"),b.active.splice(b.active.indexOf(c.attr("id")),1));else{c.transition().style("opacity","1");var e=[];a.keys.forEach(function(a){(0<=b.active.indexOf(a)||a==c.attr("id"))&&e.push(a)});b.active=e}a.redraw()};b.isActive=function(c,e){return-1<b.active.indexOf(a.keys[e])};b.reset=function(){b.active=
a.keys.slice(0);a.viz.scope.selectAll(".series .legend-series").transition().style("opacity","1");a.redraw()};return b}()}}();