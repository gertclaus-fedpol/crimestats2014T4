
/**
 * Format/informat support
 *
 * Author: CSC (KCA, HVE)
 * Date: 04 Dec 2012
 *
 * TMA 201311: modif for fedpol: disable embed
 *
 *
 */
 
var f=function(){return{format:function(b,d,e,a){a=a||"NL";if("date"==d.type)return d3.time.format(e)(b);if("numeric"==d.type||"currency"==d.type){if(null==b)return null;b=d3.format(e)(b);if("NL"==a||"FR"==a)b=b.split(",").join("|"),b=b.split(".").join(","),b=b.split("|").join(".");"currency"==d.type&&(b="\u20ac "+b);return b}return"hierarchy"!=d.type&&"geo"!=d.type||"list"==Hierarchy.type(d.values)?b:Hierarchy.subtree(d.values,b)[b][a]},informat:function(b,d,e,a){return"date"==d?d3.time.format(e).parse(b):
"currency"==d?b.split("\u20ac").join(""):"numeric"==d?parseFloat(b):b}}}(),Aggregator=function(){var b={},d;b.initialize=function(){d={sum:d3.sum,average:d3.mean,min:d3.min,max:d3.max}};b.filter=function(b,a){return 0==a.length?b:b.filter(function(g){var c=!0;a.forEach(function(a){c=c&&0<=a.discrete.indexOf(g[a.dimension])});return c})};b.aggregate=function(b,a){var g=d3.nest();a.forEach(function(a){g.key(function(g){return a.dimensions.map(function(a){return g[a]}).join("#")});g.rollup(function(g){var b=
{};a.dimensions.forEach(function(a){b[a]=g[0][a]});a.measures.forEach(function(a){b[a.measure]=d[a.type](g.map(function(c){return c[a.measure]}))});return b});var h=g.entries(b);b=[];h.forEach(function(a,c){b[c]=a.values})});return b};b.drilldown=function(d,a,g,c,h){var k=a||[];d3.entries(g).forEach(function(a){a=a.value;if(""!=a.value||h)k=k.concat([{dimension:a.dimension,discrete:!h&&a.hierarchy?Hierarchy.flatten(Hierarchy.subtree(a.hierarchy,a.value)):[a.value]}])});d=b.filter(d,k);!h&&c&&(d=b.aggregate(d,
c));return d};return b}(),gui=function(){return{createSelect:function(b,d,e,a,g){return b.append("select").attr("class",d).on("change",function(){var a=d3.event.target||d3.event.srcElement;g(a.options[a.selectedIndex].value)}).selectAll("option").data(e).enter().append("option").attr("value",function(a){return a[1]}).text(function(a){return a[0]}).filter(function(c,g){return c[1]==a}).attr("selected","selected")},createCheckbox:function(b,d,e,a){return b.append("input").attr("type","checkbox").attr("class",
d).attr("name",d).on("change",function(){a((d3.event.target||d3.event).checked)}).filter(e).attr("checked","checked")}}}(),EventBus=function(){var b={registered:{},register:function(d,e,a){b.registered[e]||(b.registered[e]=[]);b.registered[e].push({entity:d,callback:a})},emit:function(d,e,a){b.registered[e]&&b.registered[e].forEach(function(g){g.entity!=d&&g.callback(a)})}};return b}(),Viz=function(){return function(b,d,e){var a=this;this.getUrlVars=function(){for(var a=[],c,b=window.location.href.slice(window.location.href.indexOf("?")+
1).split("&"),d=0;d<b.length;d++)c=b[d].split("="),a.push(c[0]),a[c[0]]=c[1];return a};this.changeLanguage=function(a){this.lang=a.toUpperCase();this.chart.locale.select(this.lang);"fallback"!=this.mode&&(d3.i18n.months=this.chart.locale.text.Months,d3.i18n.days=this.chart.locale.text.Days)};this.changeDimensions=function(a,c,b){this.width=a;this.height=c;$(this.scopeStr+" .body").width(this.width).height(this.height);b&&(this.heightSize=this.height/530,this.widthSize=this.width/635,this.smallestSize=
Math.min(this.heightSize,this.widthSize),this.smallestSize<this.size&&(this.size=this.smallestSize),$(this.scopeStr).css("font-size",Math.min(Math.max(9,Math.floor(12*this.size)),12)+"px"),$(this.scopeStr+" .legendMainTitle").css("font-size",Math.min(Math.max(10,Math.floor(14*this.size)),14)+"px"))};this.setSource=function(){$(this.scopeStr+" .source .sourceLink").html(this.definition.subject[this.lang].source);var a=$(this.scopeStr+" .sourceLink a").attr("href");$(this.scopeStr+" .sourceLink a").bind("click",
function(){window.open(a,"_blank")});$(this.scopeStr+" .sourceLink a").attr("href","#");"fallback"!==this.mode&&$(this.scopeStr+" .exportData").attr("alt",this.chart.locale.text.Export).attr("title",this.chart.locale.text.Export)};this.drawSvg=function(){this.chart.noPrebuildSVG||this.scope.select(".body").append("svg:svg").attr("width",this.width).attr("height",this.height).attr("class","chart");this.scope.select(".legendMainTitle").text(this.definition.subject[this.lang].title);"render"==this.mode&&
(this.scope.select(".body").classed("render",!0),this.scope.select(".body").style("margin","-10px 0px 0px -10px"))};this.reset=function(){this.chart.reset()};this.drills={};this.onDrilldown=function(b){if(void 0!==a.data.dimensions[b.dimension]&&!(a.definition.options&&a.definition.options.ignoredrilldown&&0<=a.definition.options.ignoredrilldown.indexOf(b.dimension))&&(a.definition.options&&a.definition.options.ignoredrilldown||"choropleth"!=a.chart.name||b.dimension!=a.definition.geography.dimension)){var c=
a.data.dimensions[b.dimension].type,d;Hierarchy.common[c]?d=Hierarchy.common[c]:a.data.dimensions[b.dimension].values&&(d=a.data.dimensions[b.dimension].values);a.drills[b.dimension]={dimension:b.dimension,hierarchy:d,value:b.value};a.data.facts=Aggregator.drilldown(a.original.facts,a.definition.filtering,a.drills,a.definition.aggregation,a.definition.options&&a.definition.options.fully_summarized);a.chart.updateData(a.data.facts);a.chart.redraw(!0)}};this.bind=function(a,c){this.scope=d3.select(a);
this.scopeStr=a;this.chart.bind(a);this.tools.bind(a);EventBus.register(this,"drilldown",this.onDrilldown);this.initialize(c)};this.properties=this.getUrlVars();this.getUrlVar=function(a){return this.properties[a]};this.SVGSupport=document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Shape","1.0");date=new Date;this.chart=e;this.chart.viz=this;this.pathname=b;this.dpathname=d;this.path=
"data/"+b+".json?d="+date.getFullYear()+(date.getMonth()+1)+date.getDate();this.dpath="definitions/"+d+".json?d="+date.getFullYear()+(date.getMonth()+1)+date.getDate();this.lang="NL";this.size=Math.max(Math.min(this.getUrlVar("size"),1.5),0.6)||1;this.height=(this.getUrlVar("height")||530)*this.size;this.width=(this.getUrlVar("width")||635)*this.size;this.mode=this.getUrlVar("mode")?this.getUrlVar("mode"):this.SVGSupport?"normal":"fallback";this.initialize=function(b){this.changeLanguage(this.getUrlVar("lang")||
"NL");this.changeDimensions(this.width,this.height,!0);if("fallback"!==this.mode){var c=this;d3.json(this.path,function(d){c.data=d;d3.json(c.dpath,function(d){c.definition=d;Aggregator.initialize();c.original={};jQuery.extend(c.original,c.data);c.definition.filtering&&(c.data.facts=Aggregator.filter(c.data.facts,c.definition.filtering));c.definition.aggregation&&(c.data.facts=Aggregator.aggregate(c.data.facts,c.definition.aggregation));if(c.definition.options&&c.definition.options.fully_summarized){var e=
[];d3.keys(c.data.dimensions).forEach(function(b){if(0<=c.definition.options.fully_summarized.indexOf(b)&&("geo"==c.data.dimensions[b].type||c.data.dimensions[b].values)){var d="geo"==c.data.dimensions[b].type?Hierarchy.common.geo:c.data.dimensions[b].values;e.push({dimension:b,discrete:d3.keys(d[0])[0]});a.drills[b]={dimension:b,hierarchy:d,value:d3.keys(d[0])[0]}}});c.data.facts=Aggregator.filter(c.data.facts,e)}c.drawSvg();c.chart.initialize();c.tools.initialize();c.setSource();b&&b()})})}else $.getJSON(a.path,
function(c){$.getJSON(a.dpath,function(b){a.data=c;a.definition=b;$(a.scopeStr+" .body").append("<div class='nosvg'>  <img src='css/images/warning.png'>  <span>"+a.chart.locale.text.NoSVG+"</span></div>");a.chart.fallback();a.tools.fallback();a.setSource()})})};this.tools=function(){var b={bind:function(c){c=a.scope.append("div").classed("tools",!0);c.append("div").classed("toolsButton toolsLeft hidden toolsPlay",!0).text("Play |");c.append("div").classed("toolsButton toolsLeft hidden toolsInfo",
!0).text("Info |").on("click",function(){b.popup("info")});c.append("div").classed("toolsButton toolsLeft hidden toolsOptions",!0).text("Options |").on("click",function(){b.popup("options")});c.append("div").classed("toolsButton toolsLeft toolsReset",!0).text("Reset").on("click",b.reset);c.append("div").classed("toolsButton toolsLeft source",!0).text("| ").append("span").attr("class","sourceLink");c.append("div").classed("toolsButton toolsRight toolsExport",!0).on("click",b.exportData).append("img").attr("src",
"css/images/export.png",!0).classed("exportDataImg",!0);c.append("div").classed("toolsButton toolsRight toolsPrint",!0).text("Print |").on("click",function(){window.print()});c=a.scope.append("div").classed("popup hidden infoTooltip",!0);c.append("div").classed("closebutton",!0).on("click",function(){b.popup("info")}).text("X");c.append("div").classed("infoText",!0);c=a.scope.append("div").classed("popup hidden optionsTooltip",
!0);c.append("div").classed("closebutton",!0).on("click",function(){b.popup("options")}).text("X");c.append("div").classed("optionsText",!0);c=a.scope.append("div").classed("popup hidden embedTooltip",!0);c.append("div").classed("closebutton",!0).on("click",function(){b.popup("embed")}).text("X");c.append("h2").text("Embed code:");c.append("textarea").classed("embedText",!0);c=a.scope.append("div").classed("popup hidden exportTooltip",!0);c.append("div").classed("closebutton",!0).on("click",function(){b.popup("export")}).text("X");
c.append("h2").text("Export:");c.append("textarea").classed("exportTable",!0);c.append("p").classed("exportText",!0)},initialize:function(){a.scope.select(".tools").style("width",a.width+"px").show();b.showInfo();"render"==a.mode&&a.scope.select(".tools").hide()},fallback:function(){$(a.scopeStr+" .tools").css("width",a.width+"px").removeClass("hidden");b.showInfo();$(a.scopeStr+" .toolsOptions").addClass("hidden");$(a.scopeStr+" .toolsEmbed").addClass("hidden");$(a.scopeStr+" .toolsReset").addClass("hidden")},
showInfo:function(){a.definition.subject&&a.definition.subject[a.lang]&&a.definition.subject[a.lang].info&&$(a.scopeStr+" .toolsInfo").removeClass("hidden")},popup:function(c){if("info"==c&&"fallback"==a.mode)b.infoFallback();else{a.scope.selectAll(".popup:not(."+c+"Tooltip)").hide();var d=a.scope.select("."+c+"Tooltip"),e=a.width-135-(void 0!==a.chart.legendWidth?a.chart.legendWidth:0),l=a.scope.position();d.style("width",e+"px").style("left",l.x+50+"px").style("top",l.y+50+"px").toggle();d.visible()&&
("embed"==c?a.scope.select(".embedText").text('<iframe frameborder="0" scrolling="no" height="'+parseInt(a.scope.select(".body").height()+50)+'" width="'+parseInt(a.scope.select(".body").width()+50)+'" src="'+window.location+'" target="_blank" align="center"></iframe>'):"options"==c?a.chart.showOptions():"info"==c&&(a.scope.select(".infoText").html(a.definition.subject[a.lang].info),void 0!=a.definition.subject[a.lang].metadata&&a.scope.select(".infoText h2").append("a").classed("linkMetadata",!0).on("click",
function(){window.open(a.definition.subject[a.lang].metadata)}).append("img").attr("src","css/images/metadata.png").attr("title",a.chart.locale.text.Metadata).attr("alt",a.chart.locale.text.Metadata)))}},exportData:function(){window.open("data/"+a.pathname+".csv","_blank")},infoFallback:function(){$(a.scopeStr+" .popup:not(.infoTooltip)").addClass("hidden");$(a.scopeStr+" .infoTooltip").css("width",a.width-135-(void 0!==a.chart.legendWidth?a.chart.legendWidth:0)+"px").css("left",50*a.size+"px").css("top",
75*a.size+"px");$(a.scopeStr+" .infoTooltip").toggleClass("hidden");$(a.scopeStr+" .infoText").html(a.definition.subject[a.lang].info);void 0!=a.definition.subject[a.lang].metadata&&($(a.scopeStr+" .infoText h2").append('<a id="linkMetadata"><img src="css/images/metadata.png" title="'+locale.text.Metadata+'" alt="'+locale.text.Metadata+'"></a>'),$(a.scopeStr+" .linkMetadata").bind("click",function(){window.open(a.definition.subject[a.lang].metadata)}))},reset:function(){a.reset()}};return b}()}}();